# ファインチューニングで達成したい目的（目的整理）

このリポジトリは、日本語のニュース/事件記事から「人物」と「住所」を構造化抽出するためのプロンプト管理（および将来的なLoRA/QLoRA/蒸留等の学習）を扱う。  
ここでは「ファインチューニングで何を達成したいのか」を先に固定し、データ設計・学習設定・評価の迷走を減らす。

---

## 前提（運用フロー）
本システムは **2タスク分割** で運用する。

1. 人物抽出・分類: `structure_extract_person_prompt.py`
2. 住所抽出: `structure_extract_address_prompt.py`

※ 学習（SFT等）は、(1)と(2)を **別モデル/別アダプタで学習してもよい**。  
※ 旧仕様（8フィールド一体型）を学習している場合でも、最終評価では 2タスク出力→後処理→8フィールドへマッピングして一致判定する。

---

## なぜファインチューニングするのか（プロンプトだけでなく学習が効く領域）
ファインチューニングで狙うのは「知識追加」ではなく、主に **出力品質・境界判断・形式安定**。

- **形式安定**: JSONが崩れない、フィールドが欠けない、`null`/`""` の扱いが一貫する
- **境界判断**: 記事にないものを出さない（ハルシネーション抑制）、曖昧時に空で返す
- **抽出一貫性**: 人名/会社名の揺れ・括弧表記・全角数字などの表記ゆれでも同じ方針で抽出
- **分類一貫性**: 加害者判定（`is_offender` と `act`）の整合、カテゴリのブレ抑制

---

## P0（最優先）: 絶対に守るべき運用品質
評価が良くても、運用で壊れる挙動はNG。まずここを満たす。

### 形式（両タスク共通）
- **常にJSON**（単一のJSONオブジェクト）で返す
- **スキーマ準拠**（キー欠落/型違いをしない）
- **推測禁止**（本文にない情報は出さない）
- **引用ベース**: `reason` は本文の該当箇所に限定し、要約や推測を書かない

### 人物抽出タスク（`structure_extract_person_prompt.py`）
- **記事内の全人物を列挙**（取りこぼしを減らす）
- **加害者確定の条件を崩さない**: `is_offender==true` かつ `act` ありのみを加害者として採用できる出力にする
- **`name` はフルネーム優先**（姓名両方が揃うもの）。曖昧なら無理に埋めない

### 住所抽出タスク（`structure_extract_address_prompt.py`）
- **明示された住所のみ**。書かれていない住所は必ず `""`
- 住所種別を混ぜない（本社/居住地/物理犯行地点以外は入れない）
- 対面で直接の犯行地点のみ `physical_crime_occured_locations` に入れる（電話詐欺の被害者宅は入れない）

---

## P1（重要）: 指標として改善したいこと
P0を満たした上で、次を上げる。

- **人物候補の再現率**: 記事に出た人物を取りこぼさない
- **`is_offender` のF1**: 加害者/非加害者の判定ブレを減らす
- **`act` の一致率**: 記事記載どおりの法的名称の一致（表記ゆれ含む）
- **住所候補の再現率**: 明示住所の抽出漏れを減らす（推測はしない）
- **ネガティブ誤検出（FP）低下**: 犯罪者がいない記事で「それっぽい人物/住所」を出さない

---

## 非目的（やらないこと）
ここをやり始めると精度が落ちやすいので、明確に禁止しておく。

- 記事にない住所の補完（都道府県/市区町村の推定含む）
- “勤務先”や“支社所在地”など、指定外の住所種別の混入
- `police_departments` の抽出（現行2タスクのスコープ外）
- `reason` の要約/推測（本文引用に限定）

---

## 評価（最終指標と中間指標）

### 最終評価（CSV 8フィールド一致）
正解データ: `data/test/Hawks_正解データマスター - ver 5.0 csv出力用.csv` に合わせる。  
2タスク出力を後処理して8フィールドにマッピングし、未記載は `""` に正規化する。

### 中間指標（改善点の切り分け）
- JSONパース成功率 / スキーマ準拠率
- 人物取りこぼし率
- `is_offender` F1 / `act` 一致率
- ネガティブ（犯人なし）でのFP率
- 住所（居住地/本社/犯行地点）の抽出漏れ率

---

## データ設計の方針（学習で迷わないための約束）
- **ポジ/ネガ混在**で学習し、ハルシネーションを抑える（Negative Sampling）
- Devは最低でも2種用意する
  - **Dev-All（本番分布）**: 空が多い分布でFPと形式崩れを見る
  - **Dev-Positive-only**: 正例のみで取りこぼし/分類/`act` を見る
- 学習後に必要な **後処理を評価で必ず再現**（運用と評価を一致させる）

---

## “できた”の定義（合格条件の叩き台）
数値は後で調整してよいが、最低限の合格条件は先に置く。

- JSONパース成功率: **ほぼ100%**
- スキーマ準拠率: **ほぼ100%**
- ネガティブFP率: **運用許容範囲まで低い**（要目標値）
- `is_offender` と `act` の整合: **矛盾がほぼ出ない**

