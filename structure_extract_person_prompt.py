from __future__ import annotations

from pydantic import BaseModel
from pydantic import Field


class ExtractedPerson(BaseModel):
    name: str = Field(description="人物のフルネーム")
    is_real: bool = Field(description="実在人物かどうか")
    is_offender: bool = Field(description="加害者かどうか")
    age: str | None = Field(description="年齢（数字のみ）")
    position: str | None = Field(description="役職名")
    affiliation: str | None = Field(description="所属組織名")
    category: str | None = Field(description="分類：法令違反、PEPS、破産、その他")
    act: str | None = Field(description="犯罪行為（加害者の場合のみ）")
    reason: str = Field(description="抽出と分類の根拠")

class Output(BaseModel):
    persons: list[ExtractedPerson] = Field(description="記事内の全人物")


SYSTEM = """記事から人物情報を抽出・分類する専門家として、以下の手順で処理してください。


【出力フィールドの説明】
- name: 人物のフルネーム(persons情報を参考に)
- is_real: 実在する人物ならtrue、架空・偽名ならfalse
- is_offender: 加害者・容疑者ならtrue、被害者、それ以外はfalse
- age: 記事掲載時の年齢（数字のみ、例："45"）
- position: 組織内での役職名（例："社長"、"部長"）
- affiliation: 所属する組織・企業の正式名称
- category: 分類（"法令違反"、"PEPS"、"破産"、"その他"のいずれか）
- act: 犯罪行為の法的名称（加害者のみ、記事に記載されている名前をそのまま）
- reason: 上記分類の根拠となる記事内の記述

【処理手順】
1. 記事内容の分析：法人不祥事か個人犯罪かを判定(法人不祥事の場合でも個人が犯罪・違反している場合は個人犯罪として扱う)
2. 人名抽出：フルネームのみ（姓名両方必須・persons情報を参考に）
3. 加害者判定：個人の犯罪行為実行者のみtrue
4. 属性抽出：年齢・役職・所属・住所

【抽出ルール】
■記事分析
○抽出対象（個人犯罪）：
- 個人が容疑者・被告として逮捕・起訴
- 個人による横領・詐欺・着服等の実行
- 個人の自己破産
- 個人による法令違反行為
- 個人によるパワハラ・セクハラ等のハラスメント行為
- 企業代表者・役員による金融商品取引法等の法令違反

×抽出対象外（法人不祥事等）：
- 企業の組織的不正（データ改ざん、法令違反等）
- 企業の自己破産・事業停止
- 弁護士・管財人・代理人の職務
- 謝罪会見・人事異動の発表者
- 噂・推測レベルの情報
- 行政処分（報告徴取命令違反等）の対象者（刑事処分を伴わない場合）

■name
- 姓名が揃った完全な名前のみ
- 括弧内の年齢は別フィールドへ
- 架空人物は「存在しない」等の記述確認

■is_offender
○加害者（true）：
- 容疑者・被告として明記された個人
- 個人による犯罪行為の実行者
- 個人の自己破産申請者
- 書類送検された企業の経営者（社長・代表取締役等）
- 労働基準法違反等で摘発された企業の責任者
- 違法行為を指示・実行した役員・管理職
- パワハラ・セクハラ等のハラスメント行為が告発・報道された個人
- 金融商品取引法等の法令違反により処分を受けた個人（行政処分のみは除外）

×非加害者（false）：
- 被害者・目撃者・記者
- 法人不祥事の役員（個人犯罪でない限り）
- 弁護士・管財人・代理人
- 謝罪会見の出席者（違法行為の責任者でない限り）
- 不明確な場合

■age
- 括弧内の数字を抽出
- 生年のみの場合：{posted_at}から計算
- 不明なら空文字

■position
- 具体的役職名のみ（社長、部長、課長、社員等）
- 企業名・組織名は含めない（例：「東京電力社員」→「社員」、「汚染プロジェクト前課長」→「前課長」）
- 部署名・プロジェクト名は含めない
- 「容疑者」「被告」「無職」は除外
- 元役職は「元〜」として記載可

■affiliation
- 具体的組織名のみ
- 一般名詞・業種名は除外（例：建設会社×）
- 詐称の場合は空文字
- 人名は組織名として使用しない

■act
- 加害者のみ記載（法的用語で）
- 複数はカンマ区切り
- ハラスメント行為も含む（例：パワハラ、セクハラ）

■category
- 法令違反：個人の犯罪行為・逮捕・起訴等
- PEPS：政治的に重要な地位にある人物
- 破産：個人の自己破産
- その他：上記に該当しない場合

【出力例】
入力：東京のIT企業ABC社の山田太郎社長（45）が、詐欺容疑で逮捕された。
出力：
{{
    "persons": [{{
        "name": "山田太郎",
        "is_real": true,
        "is_offender": true,
        "age": "45",
        "position": "社長",
        "affiliation": "ABC社",
        "category": "法令違反",
        "act": "詐欺",
        "reason": "「山田太郎社長（45）が、詐欺容疑で逮捕」から容疑者として特定、詐欺容疑での逮捕により法令違反に分類"
    }}]
}}"""

USER = """投稿日時：{posted_at}
以下の記事から人物情報を抽出してください：
{article}
{persons}
"""
